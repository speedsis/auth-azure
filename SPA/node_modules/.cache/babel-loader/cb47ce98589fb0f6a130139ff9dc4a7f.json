{"ast":null,"code":"/*! @azure/msal-common v4.5.0 2021-07-22 */\n'use strict';\n\nimport { __awaiter, __generator } from '../_virtual/_tslib.js';\nimport { HeaderNames, Constants as Constants$1 } from '../utils/Constants.js';\nimport { ClientAuthError as ClientAuthError$1 } from '../error/ClientAuthError.js';\nimport { Logger as Logger$1 } from '../logger/Logger.js';\nimport { name, version } from '../packageMetadata.js';\nimport { buildClientInfoFromHomeAccountId } from '../account/ClientInfo.js';\nimport { buildClientConfiguration } from '../config/ClientConfiguration.js';\nimport { NetworkManager as NetworkManager$1 } from '../network/NetworkManager.js';\nimport { CcsCredentialType } from '../account/CcsCredential.js';\n/*\r\n * Copyright (c) Microsoft Corporation. All rights reserved.\r\n * Licensed under the MIT License.\r\n */\n\n/**\r\n * Base application class which will construct requests to send to and handle responses from the Microsoft STS using the authorization code flow.\r\n */\n\nvar BaseClient = function () {\n  function BaseClient(configuration) {\n    // Set the configuration\n    this.config = buildClientConfiguration(configuration); // Initialize the logger\n\n    this.logger = new Logger$1(this.config.loggerOptions, name, version); // Initialize crypto\n\n    this.cryptoUtils = this.config.cryptoInterface; // Initialize storage interface\n\n    this.cacheManager = this.config.storageInterface; // Set the network interface\n\n    this.networkClient = this.config.networkInterface; // Set the NetworkManager\n\n    this.networkManager = new NetworkManager$1(this.networkClient, this.cacheManager); // Set TelemetryManager\n\n    this.serverTelemetryManager = this.config.serverTelemetryManager; // set Authority\n\n    this.authority = this.config.authOptions.authority;\n  }\n  /**\r\n   * Creates default headers for requests to token endpoint\r\n   */\n\n\n  BaseClient.prototype.createTokenRequestHeaders = function (ccsCred) {\n    var headers = {};\n    headers[HeaderNames.CONTENT_TYPE] = Constants$1.URL_FORM_CONTENT_TYPE;\n\n    if (!this.config.systemOptions.preventCorsPreflight && ccsCred) {\n      switch (ccsCred.type) {\n        case CcsCredentialType.HOME_ACCOUNT_ID:\n          try {\n            var clientInfo = buildClientInfoFromHomeAccountId(ccsCred.credential);\n            headers[HeaderNames.CCS_HEADER] = \"Oid:\" + clientInfo.uid + \"@\" + clientInfo.utid;\n          } catch (e) {\n            this.logger.verbose(\"Could not parse home account ID for CCS Header: \" + e);\n          }\n\n          break;\n\n        case CcsCredentialType.UPN:\n          headers[HeaderNames.CCS_HEADER] = \"UPN: \" + ccsCred.credential;\n          break;\n      }\n    }\n\n    return headers;\n  };\n  /**\r\n   * Http post to token endpoint\r\n   * @param tokenEndpoint\r\n   * @param queryString\r\n   * @param headers\r\n   * @param thumbprint\r\n   */\n\n\n  BaseClient.prototype.executePostToTokenEndpoint = function (tokenEndpoint, queryString, headers, thumbprint) {\n    return __awaiter(this, void 0, void 0, function () {\n      var response;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            return [4\n            /*yield*/\n            , this.networkManager.sendPostRequest(thumbprint, tokenEndpoint, {\n              body: queryString,\n              headers: headers\n            })];\n\n          case 1:\n            response = _a.sent();\n\n            if (this.config.serverTelemetryManager && response.status < 500 && response.status !== 429) {\n              // Telemetry data successfully logged by server, clear Telemetry cache\n              this.config.serverTelemetryManager.clearTelemetryCache();\n            }\n\n            return [2\n            /*return*/\n            , response];\n        }\n      });\n    });\n  };\n  /**\r\n   * Updates the authority object of the client. Endpoint discovery must be completed.\r\n   * @param updatedAuthority\r\n   */\n\n\n  BaseClient.prototype.updateAuthority = function (updatedAuthority) {\n    if (!updatedAuthority.discoveryComplete()) {\n      throw ClientAuthError$1.createEndpointDiscoveryIncompleteError(\"Updated authority has not completed endpoint discovery.\");\n    }\n\n    this.authority = updatedAuthority;\n  };\n\n  return BaseClient;\n}();\n\nexport { BaseClient };","map":{"version":3,"sources":["../../src/client/BaseClient.ts"],"names":["Logger","NetworkManager","Constants","ClientAuthError"],"mappings":";;;;;;;;;;;;AAAA;;;;;AAqBA;;;;;AA4BI,WAAA,UAAA,CAAsB,aAAtB,EAAwD;;AAEpD,SAAK,MAAL,GAAc,wBAAwB,CAAC,aAAD,CAAtC,CAFoD,C;;AAKpD,SAAK,MAAL,GAAc,IAAIA,QAAJ,CAAW,KAAK,MAAL,CAAY,aAAvB,EAAsC,IAAtC,EAA4C,OAA5C,CAAd,CALoD,C;;AAQpD,SAAK,WAAL,GAAmB,KAAK,MAAL,CAAY,eAA/B,CARoD,C;;AAWpD,SAAK,YAAL,GAAoB,KAAK,MAAL,CAAY,gBAAhC,CAXoD,C;;AAcpD,SAAK,aAAL,GAAqB,KAAK,MAAL,CAAY,gBAAjC,CAdoD,C;;AAiBpD,SAAK,cAAL,GAAsB,IAAIC,gBAAJ,CAAmB,KAAK,aAAxB,EAAuC,KAAK,YAA5C,CAAtB,CAjBoD,C;;AAoBpD,SAAK,sBAAL,GAA8B,KAAK,MAAL,CAAY,sBAA1C,CApBoD,C;;AAuBpD,SAAK,SAAL,GAAiB,KAAK,MAAL,CAAY,WAAZ,CAAwB,SAAzC;AACH;;;;;;AAKS,EAAA,UAAA,CAAA,SAAA,CAAA,yBAAA,GAAV,UAAoC,OAApC,EAA2D;AACvD,QAAM,OAAO,GAA2B,EAAxC;AACA,IAAA,OAAO,CAAC,WAAW,CAAC,YAAb,CAAP,GAAoCC,WAAS,CAAC,qBAA9C;;AAEA,QAAI,CAAC,KAAK,MAAL,CAAY,aAAZ,CAA0B,oBAA3B,IAAmD,OAAvD,EAAgE;AAC5D,cAAQ,OAAO,CAAC,IAAhB;AACI,aAAK,iBAAiB,CAAC,eAAvB;AACI,cAAI;AACA,gBAAM,UAAU,GAAG,gCAAgC,CAAC,OAAO,CAAC,UAAT,CAAnD;AACA,YAAA,OAAO,CAAC,WAAW,CAAC,UAAb,CAAP,GAAkC,SAAO,UAAU,CAAC,GAAlB,GAAqB,GAArB,GAAyB,UAAU,CAAC,IAAtE;AACH,WAHD,CAGE,OAAO,CAAP,EAAU;AACR,iBAAK,MAAL,CAAY,OAAZ,CAAoB,qDAAqD,CAAzE;AACH;;AACD;;AACJ,aAAK,iBAAiB,CAAC,GAAvB;AACI,UAAA,OAAO,CAAC,WAAW,CAAC,UAAb,CAAP,GAAkC,UAAQ,OAAO,CAAC,UAAlD;AACA;AAXR;AAaH;;AACD,WAAO,OAAP;AACH,GApBS;;;;;;;;;;AA6BM,EAAA,UAAA,CAAA,SAAA,CAAA,0BAAA,GAAhB,UAA2C,aAA3C,EAAkE,WAAlE,EAAuF,OAAvF,EAAwH,UAAxH,EAAqJ;;;;;;AAChI,mBAAA,CAAA;AAAA;AAAA,cAAM,KAAK,cAAL,CAAoB,eAApB,CACnB,UADmB,EAEnB,aAFmB,EAGnB;AAAE,cAAA,IAAI,EAAE,WAAR;AAAqB,cAAA,OAAO,EAAE;AAA9B,aAHmB,CAAN,CAAA;;;AAAX,YAAA,QAAQ,GAAG,EAAA,CAAA,IAAA,EAAX;;AAMN,gBAAI,KAAK,MAAL,CAAY,sBAAZ,IAAsC,QAAQ,CAAC,MAAT,GAAkB,GAAxD,IAA+D,QAAQ,CAAC,MAAT,KAAoB,GAAvF,EAA4F;;AAExF,mBAAK,MAAL,CAAY,sBAAZ,CAAmC,mBAAnC;AACH;;AAED,mBAAA,CAAA;AAAA;AAAA,cAAO,QAAP,CAAA;;;;AACH,GAbe;;;;;;;AAmBhB,EAAA,UAAA,CAAA,SAAA,CAAA,eAAA,GAAA,UAAgB,gBAAhB,EAA2C;AACvC,QAAI,CAAC,gBAAgB,CAAC,iBAAjB,EAAL,EAA2C;AACvC,YAAMC,iBAAe,CAAC,sCAAhBA,CAAuD,yDAAvDA,CAAN;AACH;;AACD,SAAK,SAAL,GAAiB,gBAAjB;AACH,GALD;;AAMJ,SAAA,UAAA;AAAC,C","sourcesContent":["/*\r\n * Copyright (c) Microsoft Corporation. All rights reserved.\r\n * Licensed under the MIT License.\r\n */\r\n\r\nimport { ClientConfiguration, buildClientConfiguration, CommonClientConfiguration } from \"../config/ClientConfiguration\";\r\nimport { INetworkModule } from \"../network/INetworkModule\";\r\nimport { NetworkManager, NetworkResponse } from \"../network/NetworkManager\";\r\nimport { ICrypto } from \"../crypto/ICrypto\";\r\nimport { Authority } from \"../authority/Authority\";\r\nimport { Logger } from \"../logger/Logger\";\r\nimport { Constants, HeaderNames } from \"../utils/Constants\";\r\nimport { ServerAuthorizationTokenResponse } from \"../response/ServerAuthorizationTokenResponse\";\r\nimport { CacheManager } from \"../cache/CacheManager\";\r\nimport { ServerTelemetryManager } from \"../telemetry/server/ServerTelemetryManager\";\r\nimport { RequestThumbprint } from \"../network/RequestThumbprint\";\r\nimport { version, name } from \"../packageMetadata\";\r\nimport { ClientAuthError } from \"../error/ClientAuthError\";\r\nimport { CcsCredential, CcsCredentialType } from \"../account/CcsCredential\";\r\nimport { buildClientInfoFromHomeAccountId } from \"../account/ClientInfo\";\r\n\r\n/**\r\n * Base application class which will construct requests to send to and handle responses from the Microsoft STS using the authorization code flow.\r\n */\r\nexport abstract class BaseClient {\r\n    // Logger object\r\n    public logger: Logger;\r\n\r\n    // Application config\r\n    protected config: CommonClientConfiguration;\r\n\r\n    // Crypto Interface\r\n    protected cryptoUtils: ICrypto;\r\n\r\n    // Storage Interface\r\n    protected cacheManager: CacheManager;\r\n\r\n    // Network Interface\r\n    protected networkClient: INetworkModule;\r\n\r\n    // Server Telemetry Manager\r\n    protected serverTelemetryManager: ServerTelemetryManager | null;\r\n\r\n    // Network Manager\r\n    protected networkManager: NetworkManager;\r\n\r\n    // Default authority object\r\n    public authority: Authority;\r\n\r\n    protected constructor(configuration: ClientConfiguration) {\r\n        // Set the configuration\r\n        this.config = buildClientConfiguration(configuration);\r\n\r\n        // Initialize the logger\r\n        this.logger = new Logger(this.config.loggerOptions, name, version);\r\n\r\n        // Initialize crypto\r\n        this.cryptoUtils = this.config.cryptoInterface;\r\n\r\n        // Initialize storage interface\r\n        this.cacheManager = this.config.storageInterface;\r\n\r\n        // Set the network interface\r\n        this.networkClient = this.config.networkInterface;\r\n\r\n        // Set the NetworkManager\r\n        this.networkManager = new NetworkManager(this.networkClient, this.cacheManager);\r\n\r\n        // Set TelemetryManager\r\n        this.serverTelemetryManager = this.config.serverTelemetryManager;\r\n\r\n        // set Authority\r\n        this.authority = this.config.authOptions.authority;\r\n    }\r\n\r\n    /**\r\n     * Creates default headers for requests to token endpoint\r\n     */\r\n    protected createTokenRequestHeaders(ccsCred?: CcsCredential): Record<string, string> {\r\n        const headers: Record<string, string> = {};\r\n        headers[HeaderNames.CONTENT_TYPE] = Constants.URL_FORM_CONTENT_TYPE;\r\n\r\n        if (!this.config.systemOptions.preventCorsPreflight && ccsCred) {\r\n            switch (ccsCred.type) {\r\n                case CcsCredentialType.HOME_ACCOUNT_ID:\r\n                    try {\r\n                        const clientInfo = buildClientInfoFromHomeAccountId(ccsCred.credential);\r\n                        headers[HeaderNames.CCS_HEADER] = `Oid:${clientInfo.uid}@${clientInfo.utid}`;\r\n                    } catch (e) {\r\n                        this.logger.verbose(\"Could not parse home account ID for CCS Header: \" + e);\r\n                    }\r\n                    break;\r\n                case CcsCredentialType.UPN:\r\n                    headers[HeaderNames.CCS_HEADER] = `UPN: ${ccsCred.credential}`;\r\n                    break;\r\n            }\r\n        }\r\n        return headers;\r\n    }\r\n\r\n    /**\r\n     * Http post to token endpoint\r\n     * @param tokenEndpoint\r\n     * @param queryString\r\n     * @param headers\r\n     * @param thumbprint\r\n     */\r\n    protected async executePostToTokenEndpoint(tokenEndpoint: string, queryString: string, headers: Record<string, string>, thumbprint: RequestThumbprint): Promise<NetworkResponse<ServerAuthorizationTokenResponse>> {\r\n        const response = await this.networkManager.sendPostRequest<ServerAuthorizationTokenResponse>(\r\n            thumbprint,\r\n            tokenEndpoint,\r\n            { body: queryString, headers: headers }\r\n        );\r\n\r\n        if (this.config.serverTelemetryManager && response.status < 500 && response.status !== 429) {\r\n            // Telemetry data successfully logged by server, clear Telemetry cache\r\n            this.config.serverTelemetryManager.clearTelemetryCache();\r\n        }\r\n\r\n        return response;\r\n    }\r\n\r\n    /**\r\n     * Updates the authority object of the client. Endpoint discovery must be completed.\r\n     * @param updatedAuthority \r\n     */\r\n    updateAuthority(updatedAuthority: Authority): void {\r\n        if (!updatedAuthority.discoveryComplete()) {\r\n            throw ClientAuthError.createEndpointDiscoveryIncompleteError(\"Updated authority has not completed endpoint discovery.\");\r\n        }\r\n        this.authority = updatedAuthority;\r\n    }\r\n}\r\n"]},"metadata":{},"sourceType":"module"}